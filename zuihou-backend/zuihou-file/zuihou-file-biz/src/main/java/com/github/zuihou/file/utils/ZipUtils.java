package com.github.zuihou.file.utils;import java.io.BufferedInputStream;import java.io.BufferedOutputStream;import java.io.File;import java.io.FileInputStream;import java.io.FileOutputStream;import java.io.IOException;import java.io.InputStream;import java.io.OutputStream;import java.net.HttpURLConnection;import java.net.URL;import java.net.URLEncoder;import java.util.Enumeration;import java.util.Map;import java.util.zip.ZipEntry;import java.util.zip.ZipException;import java.util.zip.ZipFile;import java.util.zip.ZipOutputStream;import javax.servlet.ServletOutputStream;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import lombok.extern.slf4j.Slf4j;import org.apache.commons.codec.binary.Base64;/** * ZipUtils on spring-boot-filemanager * * @author <a href="mailto:akhuting@hotmail.com">Alex Yang</a> * @date 2016年08月25日 10:08 */@Slf4jpublic class ZipUtils {    public static void zipFiles(ZipOutputStream out, String path, File... srcFiles) {        path = path.replaceAll("\\*", "/");        if (!path.endsWith("/")) {            path += "/";        }        byte[] buf = new byte[1024];        try {            for (File srcFile : srcFiles) {                if (srcFile.isDirectory()) {                    File[] files = srcFile.listFiles();                    String srcPath = srcFile.getName();                    srcPath = srcPath.replaceAll("\\*", "/");                    if (!srcPath.endsWith("/")) {                        srcPath += "/";                    }                    out.putNextEntry(new ZipEntry(path + srcPath));                    zipFiles(out, path + srcPath, files);                } else {                    try (FileInputStream in = new FileInputStream(srcFile)) {                        out.putNextEntry(new ZipEntry(path + srcFile.getName()));                        int len;                        while ((len = in.read(buf)) > 0) {                            out.write(buf, 0, len);                        }                        out.closeEntry();                    }                }            }        } catch (Exception e) {            log.info("ZipUtils error {} ", e);        }    }    public static void unZipFiles(File zipFile, String descDir) throws IOException {        if (!descDir.endsWith("/")) {            descDir += "/";        }        File pathFile = new File(descDir);        if (!pathFile.exists()) {            pathFile.mkdirs();        }        try (ZipFile zip = new ZipFile(zipFile)) {            for (Enumeration entries = zip.entries(); entries.hasMoreElements(); ) {                ZipEntry entry = (ZipEntry) entries.nextElement();                String zipEntryName = entry.getName();                InputStream in = zip.getInputStream(entry);                String outPath = (descDir + zipEntryName).replaceAll("\\*", "/");                //判断路径是否存在,不存在则创建文件路径                File file = new File(outPath.substring(0, outPath.lastIndexOf('/')));                if (!file.exists()) {                    file.mkdirs();                }                //判断文件全路径是否为文件夹,如果是上面已经上传,不需要解压                if (new File(outPath).isDirectory()) {                    continue;                }                OutputStream out = new FileOutputStream(outPath);                byte[] buf1 = new byte[1024];                int len;                while ((len = in.read(buf1)) > 0) {                    out.write(buf1, 0, len);                }                in.close();                out.close();            }        } catch (ZipException e) {            throw e;        }    }    /**     * 通过流打包下载文件     *     * @param out     * @param fileName     * @param     */    public static void zipFilesByInputStream(ZipOutputStream out, String fileName, InputStream is) throws Exception {        byte[] buf = new byte[1024];        try {            out.putNextEntry(new ZipEntry(fileName));            int len;            while ((len = is.read(buf)) > 0) {                out.write(buf, 0, len);            }            is.close();//            out.closeEntry();        } catch (Exception e) {            throw e;        } finally {            if (is != null) {                is.close();            }        }    }    /**     * 下载指定输入流的图片     *     * @param     * @param     * @param     * @throws Exception     */    public static void downloadFile(InputStream is, OutputStream out) throws Exception {        try {            byte[] b = new byte[2048];            int length;            while ((length = is.read(b)) > 0) {                out.write(b, 0, length);            }        } catch (Exception e) {            throw e;        } finally {            if (out != null) {                out.close();            }            if (is != null) {                is.close();            }        }    }    public static void zipFilesByInputStream(Map<String, String> fileMap, Long fileSize, String extName, HttpServletRequest request, HttpServletResponse response) throws Exception {        HttpURLConnection connection = null;//        response.setContentType("multipart/form-data");//        response.setCharacterEncoding("UTF-8");        response.setContentType("application/octet-stream; charset=utf-8");        String downloadFileName;        String agent = request.getHeader("USER-AGENT");        if (agent != null && agent.toLowerCase().indexOf("firefox") > 0) {            downloadFileName = "=?UTF-8?B?" + (new String(Base64.encodeBase64((extName).getBytes("UTF-8")))) + "?=";        } else {            //~ \ / |:"<>?   这些字符不能被替换，因为系统允许文件名有这些字符！！            downloadFileName = URLEncoder.encode(extName, "UTF-8")                    .replaceAll("\\+", "%20").replaceAll("%28", "\\(")                    .replaceAll("%29", "\\)")                    .replaceAll("%3B", ";")                    .replaceAll("%40", "@").replaceAll("%23", "\\#")                    .replaceAll("%26", "\\&").replaceAll("%2C", "\\,")                    .replaceAll("%2B", "+").replaceAll("%25", "%")                    .replaceAll("%21", "!").replaceAll("%5E", "^")                    .replaceAll("%24", "\\$").replaceAll("%7E", "~")                    .replaceAll("%60", "`").replaceAll("%5B", "[")                    .replaceAll("%3D", "=")                    .replaceAll("%5D", "]").replaceAll("%5C", "\\\\")                    .replaceAll("%27", "'").replaceAll("%2F", "/")                    .replaceAll("%7B", "{").replaceAll("%7D", "}")                    .replaceAll("%7C", "\\|").replaceAll("%3A", "\\:")                    .replaceAll("%22", "\\\"").replaceAll("%3C", "\\<")                    .replaceAll("%3E", "\\>").replaceAll("%3F", "\\?")            ;            log.info("downloadFileName={}", downloadFileName);        }        response.setHeader("Content-Disposition", "attachment;fileName=" + downloadFileName);        if (fileSize != null && fileSize > 0) {            response.setHeader("Content-Length", String.valueOf(fileSize));        }        ServletOutputStream out = response.getOutputStream();        if (fileMap.size() == 1) {            String url = null;            for (Map.Entry<String, String> entry : fileMap.entrySet()) {                url = entry.getValue();            }            connection = getConnection(url);            ZipUtils.downloadFile(connection.getInputStream(), out);            return;        }        ZipOutputStream zos = new ZipOutputStream(out);        BufferedOutputStream bos = new BufferedOutputStream(zos);        for (Map.Entry<String, String> entry : fileMap.entrySet()) {            String fileName = entry.getKey();            String url = entry.getValue();            try {                connection = getConnection(url);                BufferedInputStream bis = new BufferedInputStream(connection.getInputStream());                zos.putNextEntry(new ZipEntry(fileName));                int len;                byte[] buf = new byte[10 * 1024];                while ((len = bis.read(buf, 0, buf.length)) != -1) {                    bos.write(buf, 0, len);                }                bis.close();                bos.flush();            } catch (Exception e) {                log.warn("打包下载多个文件异常, fileName=" + fileName + ",url=" + url, e);            } finally {                if (connection != null) {                    connection.disconnect();                }            }        }        if (bos != null) {            bos.close();        }    }    private static HttpURLConnection getConnection(String url) throws Exception {        URL conURL = new URL(url);        HttpURLConnection connection = (HttpURLConnection) conURL.openConnection();        connection.connect();        return connection;    }}